# Notifier API - Esendex Integration v1.0

API en .NET 8 (ASP.NET Core Minimal API) que se conecta a la API de Esendex y expone endpoints para listar mensajes entrantes con funcionalidades avanzadas de resiliencia, caching y seguridad.

## üöÄ Caracter√≠sticas

### Core
- **Integraci√≥n con Esendex**: Conexi√≥n real a la API de Esendex con autenticaci√≥n Basic Auth
- **Modo Mock**: Si no hay credenciales configuradas, devuelve datos de ejemplo
- **Health Check**: Endpoint para verificar el estado de la API y configuraci√≥n
- **Versionado API**: Endpoints versionados (`/api/v1/...`) con compatibilidad legacy

### Resiliencia & Performance
- **Circuit Breaker**: Protecci√≥n contra cascadas de fallos (configurable: 5 fallos/30s)
- **Retry Policy**: Reintentos autom√°ticos con exponential backoff
- **Output Caching**: Cache de respuestas de 30s (configurable)
- **Timeout Management**: Timeouts configurables por operaci√≥n
- **DNS Resilience**: Fallback autom√°tico a URL alternativa (Espa√±a/Internacional)

### Seguridad
- **API Key Protection**: Autenticaci√≥n opcional mediante header `X-API-Key`
- **CORS**: Configurado para desarrollo, validado en producci√≥n (sin wildcards)
- **Secure Logging**: Nunca registra credenciales ni cuerpos de mensajes completos
- **ProblemDetails**: Errores estandarizados con mensajes claros

### API Design
- **Paginaci√≥n Mejorada**: Headers `X-Total-Count` y `Link` (rel: first, prev, next, last)
- **Swagger UI**: Documentaci√≥n interactiva (solo Development)
- **Validaci√≥n**: L√≠mites configurables para page/pageSize
- **Account Reference**: Soporte para filtrar por cuenta Esendex

## üìã Requisitos

- .NET 8 SDK
- Variables de entorno para credenciales de Esendex (opcional, sin ellas usa datos mock)

## üîß Instalaci√≥n y Ejecuci√≥n

### 1. Restaurar dependencias

```bash
dotnet restore
```

### 2. Configurar credenciales (opcional)

#### Opci√≥n A: Archivo de configuraci√≥n (Recomendado para desarrollo)

Edita el archivo `appsettings.Local.json`:

```json
{
  "Esendex": {
    "Username": "tu.email@empresa.com",
    "ApiPassword": "EX1234567890abcdefghijk"
  }
}
```

‚úÖ **Este archivo NO se sube a Git** (est√° en `.gitignore`)

#### Opci√≥n B: Variables de entorno

**Windows (PowerShell):**
```powershell
$env:ESENDEX_USER = "tu.email@empresa.com"
$env:ESENDEX_API_PASSWORD = "EX1234567890abcdefghijk"
```

**Linux/macOS:**
```bash
export ESENDEX_USER="tu.email@empresa.com"
export ESENDEX_API_PASSWORD="EX1234567890abcdefghijk"
```

### 3. Ejecutar la aplicaci√≥n

```bash
dotnet run
```

El servidor estar√° disponible en: **http://localhost:5080**

## üì° Endpoints

### Health Check

Verifica el estado de la API y si las credenciales de Esendex est√°n configuradas.

```bash
curl http://localhost:5080/api/health
```

**Respuesta:**
```json
{
  "status": "ok",
  "esendexConfigured": true
}
```

---

### üì® Listar Mensajes Entrantes (V1)

**Endpoint principal recomendado**

```bash
curl "http://localhost:5080/api/v1/messages?direction=inbound&page=1&pageSize=10"
```

**Par√°metros:**
- `direction` (requerido): Debe ser "inbound"
- `page` (opcional, default: 1): N√∫mero de p√°gina (1-indexed)
- `pageSize` (opcional, default: 50): Tama√±o de p√°gina (min: 1, max: 200)
- `accountRef` (opcional): Filtrar por Account Reference de Esendex

**Headers de Respuesta:**
```
X-Total-Count: 123
Link: <http://localhost:5080/api/v1/messages?page=1&pageSize=10>; rel="first", 
      <http://localhost:5080/api/v1/messages?page=2&pageSize=10>; rel="next", 
      <http://localhost:5080/api/v1/messages?page=13&pageSize=10>; rel="last"
Cache-Control: public, max-age=30
```

**Respuesta:**
```json
{
  "items": [
    {
      "id": "789151cb-884a-4e33-aa48-436191fe2860",
      "from": "+34607889376",
      "to": "+34987654321",
      "message": "Hola buenas esto es una prueba para ver si func...",
      "receivedUtc": "2025-10-01T09:34:42.71Z"
    }
  ],
  "page": 1,
  "pageSize": 10,
  "total": 123
}
```

---

### üì® Listar Mensajes (Legacy)

**Endpoint de compatibilidad** - Se recomienda usar `/api/v1/messages`

```bash
curl "http://localhost:5080/api/messages?direction=inbound&page=1&pageSize=10"
```

Mismos par√°metros y respuesta que v1.

---

### üîê Con API Key (si est√° habilitada)

```bash
curl -H "X-API-Key: tu_api_key_aqui" \
  "http://localhost:5080/api/v1/messages?direction=inbound&page=1&pageSize=10"
```

---

### üîç Filtrar por Account Reference

Si tienes m√∫ltiples cuentas Esendex:

```bash
curl "http://localhost:5080/api/v1/messages?direction=inbound&page=1&pageSize=10&accountRef=EX0375657"
```

---

## üìö Swagger UI (Solo Development)

Cuando ejecutas en modo Development, puedes acceder a la documentaci√≥n interactiva:

**URL:** http://localhost:5080/swagger

Desde ah√≠ puedes:
- Ver todos los endpoints disponibles
- Probar llamadas directamente
- Ver ejemplos de request/response
- Configurar API Key si est√° habilitada

---

## ‚öôÔ∏è Configuraci√≥n

### appsettings.json

```json
{
  "Esendex": {
    "BaseUrl": "https://api.esendex.com/v1.0/",
    "AlternativeBaseUrl": "https://api.esendex.es/v1.0/",
    "PreferredFormat": "xml",
    "TimeoutSeconds": 10,
    "RetryCount": 2,
    "RetryDelayMilliseconds": 1000,
    "CircuitBreakerFailureThreshold": 5,
    "CircuitBreakerSamplingDuration": 30,
    "CircuitBreakerBreakDuration": 30,
    "MinPageSize": 1,
    "MaxPageSize": 200
  },
  "Cors": {
    "AllowedOrigins": ["http://localhost:5173"]
  },
  "ApiKey": {
    "Enabled": false,
    "Value": ""
  },
  "OutputCache": {
    "DefaultExpirationSeconds": 30
  }
}
```

**Par√°metros configurables:**

#### Esendex
- `BaseUrl`: URL principal de la API (internacional o regional)
- `AlternativeBaseUrl`: URL de fallback si la principal falla
- `PreferredFormat`: "xml" o "json" (Esendex devuelve XML por defecto)
- `TimeoutSeconds`: Timeout de llamadas HTTP
- `RetryCount`: N√∫mero de reintentos
- `RetryDelayMilliseconds`: Delay base para exponential backoff
- `CircuitBreakerFailureThreshold`: Fallos antes de abrir el circuit breaker
- `CircuitBreakerSamplingDuration`: Ventana de tiempo para contar fallos (segundos)
- `CircuitBreakerBreakDuration`: Tiempo que el circuit breaker permanece abierto (segundos)
- `MinPageSize` / `MaxPageSize`: L√≠mites de paginaci√≥n

#### CORS
- `AllowedOrigins`: Lista de or√≠genes permitidos (no usar wildcards en producci√≥n)

#### API Key
- `Enabled`: Activar/desactivar protecci√≥n por API Key
- `Value`: El API Key v√°lido (usar secretos en producci√≥n)

#### Output Cache
- `DefaultExpirationSeconds`: Duraci√≥n del cache de respuestas

---

## üîÑ Estrategia de Resiliencia

### Circuit Breaker
Si Esendex falla repetidamente, el circuit breaker se abre temporalmente para:
- Evitar sobrecarga del servicio externo
- Responder r√°pidamente con error 503 sin intentar llamadas
- Cerrar autom√°ticamente despu√©s del tiempo configurado

**Respuesta cuando est√° abierto:**
```json
{
  "status": 503,
  "title": "Service Temporarily Unavailable",
  "detail": "The Esendex service is temporarily unavailable due to repeated errors. Please try again later."
}
```

### Retry Policy
Reintentos autom√°ticos con exponential backoff:
- 1er reintento: 1 segundo
- 2do reintento: 2 segundos
- Solo en errores transitorios (timeout, 5xx, etc.)

### DNS Fallback
Si `BaseUrl` falla por problemas de DNS o conectividad, intenta autom√°ticamente con `AlternativeBaseUrl`:
- √ötil para cuentas regionales (.com / .es)
- Registra en logs cu√°l URL funcion√≥

---

## üîê Seguridad

### Activar API Key Protection

1. **Configurar en appsettings.json:**
```json
{
  "ApiKey": {
    "Enabled": true,
    "Value": "mi-api-key-secreta-123"
  }
}
```

2. **Incluir en requests:**
```bash
curl -H "X-API-Key: mi-api-key-secreta-123" \
  "http://localhost:5080/api/v1/messages?direction=inbound&page=1&pageSize=10"
```

3. **Swagger UI:**
   - Haz clic en "Authorize"
   - Ingresa tu API Key
   - Todas las requests incluir√°n el header autom√°ticamente

### Recomendaciones para Producci√≥n

1. **Secretos:**
   - Usar Azure Key Vault, AWS Secrets Manager o HashiCorp Vault
   - NO usar variables de entorno en producci√≥n
   - NO hacer commit de credenciales

2. **CORS:**
   - Configurar solo dominios espec√≠ficos
   - NO usar wildcards (`*`)
   - Ejemplo:
     ```json
     "AllowedOrigins": ["https://app.miempresa.com"]
     ```

3. **HTTPS:**
   - Configurar certificados SSL/TLS
   - Forzar HTTPS en producci√≥n

4. **Rate Limiting:**
   - Implementar l√≠mites por IP/API Key
   - Proteger contra abusos

5. **Logging y Monitoring:**
   - Application Insights, Serilog, o ELK Stack
   - Alertas para errores 401/403/502/503
   - **Nunca loguear**: credenciales, API Keys, cuerpos completos de mensajes

---

## üß™ Testing Manual

### 1. Health Check
```bash
curl http://localhost:5080/api/health
```

### 2. Mensajes Mock (sin credenciales)
```bash
curl "http://localhost:5080/api/v1/messages?direction=inbound&page=1&pageSize=5"
```

### 3. Mensajes Reales (con credenciales)
Configura credenciales y ejecuta:
```bash
curl "http://localhost:5080/api/v1/messages?direction=inbound&page=1&pageSize=5"
```

### 4. Verificar Headers de Paginaci√≥n
```bash
curl -i "http://localhost:5080/api/v1/messages?direction=inbound&page=2&pageSize=10"
```
Busca headers `X-Total-Count` y `Link`.

### 5. Probar Cache
```bash
# Primera llamada (sin cache)
curl -i "http://localhost:5080/api/v1/messages?direction=inbound&page=1&pageSize=5"

# Segunda llamada (desde cache - m√°s r√°pida)
curl -i "http://localhost:5080/api/v1/messages?direction=inbound&page=1&pageSize=5"
```
Verifica header `Cache-Control`.

### 6. Probar API Key (si est√° habilitada)
```bash
# Sin API Key (debe fallar con 401)
curl "http://localhost:5080/api/v1/messages?direction=inbound&page=1&pageSize=5"

# Con API Key (debe funcionar)
curl -H "X-API-Key: tu-api-key" \
  "http://localhost:5080/api/v1/messages?direction=inbound&page=1&pageSize=5"
```

---

## üêõ Troubleshooting

### Error 401/403 - Authentication Failed
- Verifica que las credenciales sean correctas
- El API Password es diferente de tu contrase√±a web
- Obt√©n el API Password desde: Settings ‚Üí API Access en el portal de Esendex

### Error 502 - Service Unavailable
- Esendex no est√° disponible o hay problemas de red
- Verifica conectividad a internet
- Revisa logs para ver qu√© URL fall√≥

### Error 503 - Circuit Breaker Open
- El circuit breaker est√° abierto por m√∫ltiples fallos
- Espera 30 segundos (configurable) y reint√©ntalo
- Revisa logs para identificar el problema ra√≠z

### esendexConfigured: false
- Las credenciales no est√°n cargadas
- Verifica variables de entorno o `appsettings.Local.json`
- Reinicia la aplicaci√≥n despu√©s de configurar

### Cache no funciona
- Verifica header `Cache-Control` en la respuesta
- El cache var√≠a por query params (page, pageSize, direction, accountRef)
- En Development, el cache puede estar deshabilitado

---

## üìù Estructura del Proyecto

```
Notifier-API/
‚îú‚îÄ‚îÄ Program.cs                      # Configuraci√≥n Minimal API + DI + Middleware
‚îú‚îÄ‚îÄ Notifier-API.csproj             # Proyecto .NET 8
‚îú‚îÄ‚îÄ appsettings.json                # Configuraci√≥n general
‚îú‚îÄ‚îÄ appsettings.Local.json          # Credenciales locales (no en Git)
‚îú‚îÄ‚îÄ README.md                       # Este archivo
‚îú‚îÄ‚îÄ Configuration/
‚îÇ   ‚îú‚îÄ‚îÄ EsendexSettings.cs          # Settings de Esendex
‚îÇ   ‚îú‚îÄ‚îÄ ApiKeySettings.cs           # Settings de API Key
‚îÇ   ‚îî‚îÄ‚îÄ OutputCacheSettings.cs      # Settings de Output Cache
‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îú‚îÄ‚îÄ MessageDto.cs               # DTO para mensajes
‚îÇ   ‚îú‚îÄ‚îÄ MessagesResponse.cs         # Respuesta paginada
‚îÇ   ‚îî‚îÄ‚îÄ HealthResponse.cs           # Respuesta health check
‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îú‚îÄ‚îÄ IInboxService.cs            # Interfaz del servicio
‚îÇ   ‚îú‚îÄ‚îÄ EsendexInboxService.cs      # Implementaci√≥n real (Esendex)
‚îÇ   ‚îî‚îÄ‚îÄ MockInboxService.cs         # Implementaci√≥n mock
‚îú‚îÄ‚îÄ Middleware/
‚îÇ   ‚îî‚îÄ‚îÄ ApiKeyMiddleware.cs         # Middleware de autenticaci√≥n
‚îî‚îÄ‚îÄ Helpers/
    ‚îî‚îÄ‚îÄ PaginationHelper.cs         # Helpers para paginaci√≥n
```

---

## üì¶ Dependencias

- **Microsoft.AspNetCore.OpenApi** (8.0.0): Soporte OpenAPI
- **Swashbuckle.AspNetCore** (6.5.0): Swagger UI
- **Polly** (8.2.0): Pol√≠ticas de resiliencia
- **Polly.Extensions.Http** (3.0.0): Integraci√≥n HTTP con Polly
- **Microsoft.Extensions.Http.Polly** (8.0.0): Circuit Breaker y Retry

---

## üìÑ Licencia

Este proyecto es c√≥digo de ejemplo para integraci√≥n con Esendex.

---

## ü§ù Contribuir

Para mejoras o reportar issues, contacta con el equipo de desarrollo.

---

**Nota**: Recuerda nunca compartir tus credenciales de API. Mantenlas seguras y usa secret stores en producci√≥n.

Ver tambi√©n: `PRODUCTION-GUIDE.md` para gu√≠a completa de despliegue en producci√≥n.
